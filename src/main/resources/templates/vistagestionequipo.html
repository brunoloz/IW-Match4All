<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="~{fragments/head :: header}" />
    <title>IW: Match4All</title>
</head>

<body>
    <header th:replace="~{fragments/nav.html :: nav}"></header>

    <main class="container py-4">
        <div class="row g-3 align-items-start">
            <section class="col-12 col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h2 class="h5 mb-0">Plantilla</h2>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="player-table" class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Jugador</th>
                                        <th>Posición</th>
                                        <th>Goles</th>
                                        <th>Asistencias</th>
                                        <th class="text-end" style="width: 56px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="player-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="col-12 col-lg-4 d-flex flex-column gap-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img th:src="@{/img/user.jpg}" src="/img/user.jpg" alt="Escudo del equipo" class="rounded" width="72" height="72">
                            <div>
                                <h2 class="h5 mb-0">Demo Team</h2>
                                <p class="mb-0 text-muted">Temporada 2025/26</p>
                            </div>
                        </div>

                        <div class="row g-2 text-center">
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div class="fw-bold">3</div>
                                    <small class="text-muted">Ligas</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div class="fw-bold">19</div>
                                    <small class="text-muted">Goles</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <div id="team-size-stat" class="fw-bold">0</div>
                                    <small class="text-muted">Jugadores</small>
                                </div>
                            </div>
                        </div>

                        <div th:if="${u != null && u.hasRole('ADMIN')}" class="mt-3">
                            <span class="badge text-bg-primary">Modo administración simple</span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header">
                        <h3 class="h6 mb-0">Ligas en juego</h3>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex align-items-center gap-2">
                            <img th:src="@{/img/logomatch4all.png}" src="/img/logomatch4all.png" alt="Liga" class="rounded" width="32" height="32">
                            <div class="d-flex align-items-baseline justify-content-between gap-2 w-100">
                                <span class="fw-semibold">Liga Match4All - Primera</span>
                                <span class="fw-bold text-nowrap">3º · 18 pts</span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center gap-2">
                            <img th:src="@{/img/logomatch4all.png}" src="/img/logomatch4all.png" alt="Liga" class="rounded" width="32" height="32">
                            <div class="d-flex align-items-baseline justify-content-between gap-2 w-100">
                                <span class="fw-semibold">Copa Match4All</span>
                                <span class="fw-bold text-nowrap">1º · 9 pts</span>
                            </div>
                        </li>
                        <li class="list-group-item d-flex align-items-center gap-2">
                            <img th:src="@{/img/logomatch4all.png}" src="/img/logomatch4all.png" alt="Liga" class="rounded" width="32" height="32">
                            <div class="d-flex align-items-baseline justify-content-between gap-2 w-100">
                                <span class="fw-semibold">Liga de Verano</span>
                                <span class="fw-bold text-nowrap">5º · 11 pts</span>
                            </div>
                        </li>
                    </ul>
                </div>

                <div id="admin-panel" th:if="${u != null && u.hasRole('ADMIN')}" class="card shadow-sm">
                    <div class="card-header">
                        <h3 class="h6 mb-0">Gestión rápida</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Acciones directas</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button id="add-existing-player" type="button" class="btn btn-primary btn-sm">Añadir jugador predefinido</button>
                                <button id="approve-request" type="button" class="btn btn-success btn-sm">Aceptar solicitud predefinida</button>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-between gap-2">
                            <small class="text-muted">Pendientes de solicitud</small>
                            <span id="request-count" class="badge text-bg-light border">0</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-between gap-2 mt-2">
                            <small class="text-muted">Jugadores disponibles</small>
                            <span id="pool-count" class="badge text-bg-light border">0</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        (() => {
            const isAdmin = Boolean(config && config.admin);
            const playerList = document.getElementById('player-list');
            const teamSizeStat = document.getElementById('team-size-stat');
            const requestCount = document.getElementById('request-count');
            const poolCount = document.getElementById('pool-count');
            const addExistingPlayerBtn = document.getElementById('add-existing-player');
            const approveRequestBtn = document.getElementById('approve-request');

            const players = [
                { id: 1, name: 'Pablo Rodríguez', position: 'MC', goals: 2, assists: 5 },
                { id: 2, name: 'Bruno Lozano', position: 'DC', goals: 7, assists: 3 },
                { id: 3, name: 'Siro Fernández', position: 'DFC', goals: 1, assists: 2 }
            ];

            const pendingRequests = [
                { id: 4, name: 'Mario Díaz', note: 'Delantero · solicitud pendiente' },
                { id: 5, name: 'Lucía Romero', note: 'Portera · solicitud pendiente' }
            ];

            const existingPlayersPool = [
                { id: 6, name: 'Álvaro Ruiz', position: 'ED', goals: 3, assists: 1 },
                { id: 7, name: 'Marta Vega', position: 'MC', goals: 2, assists: 4 },
                { id: 8, name: 'Irene Torres', position: 'LI', goals: 0, assists: 2 }
            ];

            const renderPlayers = () => {
                playerList.innerHTML = '';

                players.forEach((player) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <img src="/img/user.jpg" alt="Jugador" class="rounded-circle" width="28" height="28">
                                <span class="fw-semibold">${player.name}</span>
                            </div>
                        </td>
                        <td>${player.position}</td>
                        <td>${player.goals}</td>
                        <td>${player.assists}</td>
                        <td class="text-end" style="width: 56px;">
                            ${isAdmin ? `<button data-action="remove" data-id="${player.id}" class="btn btn-sm btn-outline-danger">Quitar</button>` : ''}
                        </td>
                    `;
                    playerList.appendChild(row);
                });

                const size = String(players.length);
                if (teamSizeStat) {
                    teamSizeStat.textContent = size;
                }
            };

            const renderCounters = () => {
                if (!requestCount || !poolCount) {
                    return;
                }

                requestCount.textContent = String(pendingRequests.length);
                poolCount.textContent = String(existingPlayersPool.length);
            };

            playerList.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) {
                    return;
                }

                const action = target.getAttribute('data-action');
                const id = Number(target.getAttribute('data-id'));
                if (!action || Number.isNaN(id) || !isAdmin) {
                    return;
                }

                if (action === 'remove') {
                    const index = players.findIndex((player) => player.id === id);
                    if (index >= 0) {
                        players.splice(index, 1);
                        renderPlayers();
                    }
                }
            });

            if (addExistingPlayerBtn) {
                addExistingPlayerBtn.addEventListener('click', () => {
                    if (!isAdmin || existingPlayersPool.length === 0) {
                        alert('No hay jugadores predefinidos disponibles.');
                        return;
                    }

                    const selectedPlayer = existingPlayersPool.shift();
                    players.push({
                        id: Date.now(),
                        name: selectedPlayer.name,
                        position: selectedPlayer.position,
                        goals: selectedPlayer.goals,
                        assists: selectedPlayer.assists
                    });

                    renderPlayers();
                    renderCounters();
                });
            }

            if (approveRequestBtn) {
                approveRequestBtn.addEventListener('click', () => {
                    if (!isAdmin || pendingRequests.length === 0) {
                        alert('No hay solicitudes pendientes.');
                        return;
                    }

                    const approvedRequest = pendingRequests.shift();
                    players.push({
                        id: Date.now(),
                        name: approvedRequest.name,
                        position: 'MC',
                        goals: 0,
                        assists: 0
                    });

                    renderPlayers();
                    renderCounters();
                });
            }

            renderPlayers();
            renderCounters();
        })();
    </script>

    <th:block th:replace="~{fragments/footer.html :: footer}" />
</body>

</html>
